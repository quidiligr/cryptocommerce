var express = require('express');
var bcrypt = require('bcrypt');
var router = express.Router();
const AccountController = require('../controller/account.controller') 
/*
router.get('/dashboard', function(req, res, next) { 
    var db = req.db;
    var categoryTable = db.get('categories'); 
    var brandTable = db.get('brands'); 
    var ordersTable = db.get('orders');
    
    async.parallel([
        function(callback){
            categoryTable.find({status: true},{}, function(e, categories){
                callback(null, categories);
            });            
        },
        function(callback){
            brandTable.find({status: true},{}, function(e, brands){
                callback(null, brands);
            });
        },
        function(callback){
            ordersTable.find({username: req.session.username}, function(e, orders) {
                callback(null, orders);
            });
        }
    ], 
    function(err, results) {
        var data = {categories: results[0], brands: results[1], orders: results[2] };
        res.render('account/dashboard', data);
    });
});
*/

//router.get('/login', AccountController.get_login)

router.get('/verify-email', function(req, res, next) { 
    
    
        let data = {
            input:{
                code:'',
                email:'',
                username:''
                }
        }
            res.render('account/verify-email',data)
      //  });
        
    });

//router.get('/sign-up', function(req, res, next) { 
/*
router.get('/register', function(req, res, next) { 

       let data = {
        register:{
            fname:'',
            lname:'',
            username:'',
            email:'',
            password:'',
            phone:''},
            error:{message:''}
    }
        res.render('account/register',data)
  //  });
    
});


router.post('/register',  AccountController.post_register) 

router.post('/verify-email',  AccountController.post_verify_email) 
*/
//router.post('/sign-up', function(req, res, next) { 
    /*
router.post('/register', function(req, res, next) { 
    //var db = req.db;
    //var categoryTable = db.get('categories'); 
    //var brandTable = db.get('brands'); 
    var accountTable = db.get('accounts');
    
    async.parallel([
        
        function(callback){
            accountTable.count({username: req.body.username}, function(e, count) {
                if(count == 0) {
                    bcrypt.hash(req.body.password, 13, function(err, hash) {
                        req.body.password = hash;
                        req.body.status = true;
                        req.body.roleId = 'customer';
                        req.body.fullName = `${req.body['fname']} ${req.body['lname']}`
                        
                        accountTable.insert(req.body, function(err, result){
                            callback(null, {count: 0});                            
                        });
                    });
                } else {
                    callback(null, {count: count});
                }
            });
        }
    ], 
    function(err, results) {
        //var data = {categories: results[0], brands: results[1] };
        //var countAccount = results[2];
        var countAccount = results[0];
        if(countAccount.count == 0) {
            res.title = 'Login'; 
            res.redirect('account/login');
        } else {
            res.title = 'Register'; 
            data['message'] = 'Exists';
            res.render('account/register',{error:'Account already exists.'});
        }
    });
});

*/

/*
router.get('/login', function(req, res, next) { 
    
    var db = req.db;
    var categoryTable = db.get('categories'); 
    var brandTable = db.get('brands'); 
    var accountTable = db.get('accounts');
    
    async.parallel([
        function(callback){
            categoryTable.find({status: true},{}, function(e, categories){
                callback(null, categories);
            });            
        },
        function(callback){
            brandTable.find({status: true},{}, function(e, brands){
                callback(null, brands);
            });
        }
    ], 
    function(err, results) {
        var data = {categories: results[0], brands: results[1] };
        //res.render('account/login', data);
        res.render('account/login', data);
    });
});
*/



//router.post('/login', AccountController.post_login) 

router.get('/add-wallet', AccountController.post_addwallet)


/*
router.post('/login', function(req, res, next) { 

    console.log('107: START /login')
    console.log(`108: ${JSON.stringify(req.body,null,4)}`)
    

    var db = req.db;
    var categoryTable = db.get('categories'); 
    var brandTable = db.get('brands'); 
    var accountTable = db.get('accounts');
    
    async.parallel([
        
        function(callback){
            
            
            let password = req.body.password
            let username =''
            let email = ''
            if(req.body.email.includes('@')){
                
                email=req.body.email
            }
            else{
                username =req.body.email
            }

            let qry_find = {}
            
            if(username){
                qry_find = {$and: [{username: username}, {status: true}, {roleId: 'customer'}]}
            }
            else{
                qry_find = {$and: [{email: email}, {status: true}, {roleId: 'customer'}]}
            }
            
            accountTable.findOne(qry_find, function(e, account){
                if(account != null) {
                    bcrypt.compare(password, account.password, function(err, res) {
                        if(res) {
                            req.session.username = account.username;
                            req.session.roleId = account.roleId;
                            req.session.name = account.fullName;
                            req.session.user = {
                                username:account.username,
                                roleId:account.roleId,
                                name: account.fullName,
                                email: account.email,
                                currency: account.currency,
                                wallet:account.wallet

                            }
                            
                            
                                
                            callback(null, {count: 1});
                        } else {
                            callback(null, {count: 0});
                        }
                    });
                } else {
                    callback(null, {count: 0});
                }
            });
        }
    ], 
    function(err, results) {
        //var data = {categories: results[0], brands: results[1] };
        //var countAccount = results[2];
        var countAccount = results[0];
        if(countAccount.count == 0) {
            console.log('80: /login FAILED')
            data['message'] = 'Invalid Account'
            res.render('account/login')
            //res.redirect('/')
        } else {
            console.log('80: /login OK')
            //res.redirect('/account/orders')
            let return_url = req.session['return_url']
            if(return_url == null || return_url == '' ){
                return_url = '/'
            }
            

            res.redirect(return_url)
                            
            //res.redirect('/home/dashboard')
            //res.redirect('/');
        }
        
    });
});
*/

router.get('/logout', function(req, res, next) { 
    var db = req.db;
    var categoryTable = db.get('categories'); 
    var brandTable = db.get('brands'); 
    
    async.parallel([
        function(callback){
            categoryTable.find({status: true},{}, function(e, categories){
                callback(null, categories);
            });            
        },
        function(callback){
            brandTable.find({status: true},{}, function(e, brands){
                callback(null, brands);
            });
        },
        function(callback){
            delete req.session.username;
            delete req.session.user;
            
            callback();
        }
    ], 
    function(err, results) {
        var data = {categories: results[0], brands: results[1] };
        res.redirect('/');
    });
});

router.get('/change-profile', function(req, res, next) { 
    var db = req.db;
    var categoryTable = db.get('categories'); 
    var brandTable = db.get('brands'); 
    var accountTable = db.get('accounts');
    
    async.parallel([
        function(callback){
            categoryTable.find({status: true},{}, function(e, categories){
                callback(null, categories);
            });            
        },
        function(callback){
            brandTable.find({status: true},{}, function(e, brands){
                callback(null, brands);
            });
        },
        function(callback){
            accountTable.findOne({username: req.session.username}, function(e, account){
                callback(null, account);
            });
        }
    ], 
    function(err, results) {
        var data = {categories: results[0], brands: results[1], account: results[2] };
        res.render('account/change_profile', data);
    });
});

router.post('/change-profile', function(req, res, next) { 
    var db = req.db;
    var categoryTable = db.get('categories'); 
    var brandTable = db.get('brands'); 
    var accountTable = db.get('accounts');
    
    async.parallel([
        function(callback){
            categoryTable.find({status: true},{}, function(e, categories){
                callback(null, categories);
            });            
        },
        function(callback){
            brandTable.find({status: true},{}, function(e, brands){
                callback(null, brands);
            });
        },
        function(callback){
            accountTable.findOne({username: req.session.username}, function(e, account) {
                if(req.body.password != '') {
                    bcrypt.hash(req.body.password, 13, function(err, hash) {                        
                        accountTable.update({username: req.session.username}, {$set : {password: hash, fullName: req.body.fullName, email: req.body.email}}, function(e, result) {
                            accountTable.findOne({username: req.session.username}, function(e, account) {
                                callback(null, account);
                            });
                        });
                    });
                } else {                    
                    accountTable.update({username: req.session.username}, {$set : {fullName: req.body.fullName, email: req.body.email}}, function(e, result) {
                        accountTable.findOne({username: req.session.username}, function(e, account) {
                            callback(null, account);
                        });
                    });
                }
            });
        }
    ], 
    function(err, results) {
        var data = {categories: results[0], brands: results[1], account: results[2] };
        res.render('account/change_profile', data);
    });
});




router.get('/orders', function(req, res, next) { 
    var db = req.db;
    var categoryTable = db.get('categories'); 
    var brandTable = db.get('brands'); 
    var ordersTable = db.get('orders');
    
    async.parallel([
        function(callback){
            categoryTable.find({status: true},{}, function(e, categories){
                callback(null, categories);
            });            
        },
        function(callback){
            brandTable.find({status: true},{}, function(e, brands){
                callback(null, brands);
            });
        },
        function(callback){
            ordersTable.find({username: req.session.username}, function(e, orders) {
                callback(null, orders);
            });
        }
    ], 
    function(err, results) {
        var data = {categories: results[0], brands: results[1], orders: results[2] };
        res.render('account/orders', data);
    });
});

router.get('/order/detail/:id', function(req, res, next) { 
    var db = req.db;
    var categoryTable = db.get('categories'); 
    var brandTable = db.get('brands'); 
    var ordersTable = db.get('orders');
    var ordersDetailTable = db.get('orderdetails');
    
    async.parallel([
        function(callback){
            categoryTable.find({status: true},{}, function(e, categories){
                callback(null, categories);
            });            
        },
        function(callback){
            brandTable.find({status: true},{}, function(e, brands){
                callback(null, brands);
            });
        },
        function(callback) {
          
            ordersDetailTable.aggregate({
                $lookup:{
                    from:"products",
                    localField:"productId",
                    foreignField:"id",
                    as:"productInfo"
                }                
            }, function(e, result) { 
                    var orderDetails = [];
                    for(var i = 0; i < result.length; i++) {
                        if(result[i].orderId == req.params.id) {
                            orderDetails.push(result[i]);
                        }
                    }
                    callback(null, orderDetails);
            });
            
        }
    ], 
    function(err, results) {
        var data = {categories: results[0], brands: results[1], orderDetails: results[2] };
        res.render('account/orders_detail', data);
    });
});

module.exports = router;
